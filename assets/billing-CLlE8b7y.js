var fe=Object.defineProperty;var we=(s,e,n)=>e in s?fe(s,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[e]=n;var l=(s,e,n)=>we(s,typeof e!="symbol"?e+"":e,n);import{B as Ie,N as ne,P as se,d as K,A as be}from"./index-CCdNvfV5.js";import{d as J,c as f,j as a,t as h,k as C,w as b,u as o,l as U,S as _,o as g,F as B,C as re,f as F,i as z,X as k,r as S,I as i,ag as ie,ah as De,ac as oe,ad as L,aa as ce,ai as Pe,a7 as Z,b as G,M as Y,J as O,G as le,aj as ke,a3 as Fe,ak as Te,g as Ce,h as Je,R as Ee,af as Oe}from"./index-CI1TXeFk.js";import{B as V,A as Me,C as ee,I as $e}from"./error-ByG0LKAC.js";import{_ as E}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{P as j}from"./index-BsVT9ERs.js";import{D as de}from"./date-DLmiVZsx.js";import{D as q,b as M,e as D,w as R}from"./index.vue_vue_type_style_index_0_scoped_f01006ee_lang-ijOL3OAg.js";class ue{constructor(e){l(this,"name",q.ChangeCc);l(this,"createPaymentSetupIntent");l(this,"createPaymentMethod");l(this,"listPaymentMethods");l(this,"deletePaymentMethod");this.createPaymentSetupIntent=e.createPaymentSetupIntent,this.createPaymentMethod=e.createPaymentMethod,this.listPaymentMethods=e.listPaymentMethods,this.deletePaymentMethod=e.deletePaymentMethod}}class Ne{constructor(e){l(this,"name",q.Pay);this.bill=e}}class Ae{constructor(e){l(this,"name",q.ConfirmPayment);this.bill=e}}class xe{constructor(e){l(this,"name",q.EditBillingAddress);l(this,"ws");l(this,"listCountries");l(this,"updateWorkspace");this.ws=e.ws,this.listCountries=e.listCountries,this.updateWorkspace=e.updateWorkspace}}var $=(s=>(s.Info="info",s.Error="error",s))($||{});const Re=["data-typ"],Ue=["src"],Be={class:"notice__main"},Le=["data-typ"],We={key:0,class:"notice__main__actions"},je=J({__name:"index",props:{typ:{type:String,required:!1,default:$.Info},msg:{type:String,required:!0},actions:{type:Array,default:()=>[]}},setup(s){const e=s,n=()=>{switch(e.typ){case $.Info:return"/icon/info-teal.svg";case $.Error:return"/icon/error-tsubaki-d2.svg";default:return _.handleError(new Error(`Unknown notice type: ${e.typ}`)),""}};return(t,r)=>(g(),f("div",{class:"notice","data-typ":s.typ},[a("img",{class:"notice__icon",src:n()},null,8,Ue),a("div",Be,[a("p",{class:"notice__main__msg","data-typ":s.typ},h(s.msg),9,Le),s.actions.length?(g(),f("div",We,[C(Ie,{"align-h":o(Me).Left},{default:b(()=>[(g(!0),f(B,null,re(s.actions,c=>(g(),F(V,{key:c.id,onClick:c.onClick},{default:b(()=>[z(h(c.label),1)]),_:2},1032,["onClick"]))),128))]),_:1},8,["align-h"])])):U("",!0)])],8,Re))}}),qe=E(je,[["__scopeId","data-v-b1d77220"]]);var p=(s=>(s.Product="product",s.User="user",s))(p||{});class w{constructor(e,n,t,r){this.chargeType=e,this.chargedFrom=n,this.chargedTo=t,this.chargeJpy=r}static create(e){return new w(e.chargeType,new Date(e.chargedFrom),new Date(e.chargedTo),e.chargeJpy)}}class P{constructor(e,n,t,r,c,d){this.id=e,this.paymentId=n,this.chargeType=t,this.chargedFrom=r,this.chargedTo=c,this.chargeJpy=d}static create(e){return new P(e.id,e.paymentId,e.chargeType,new Date(e.chargedFrom),new Date(e.chargedTo),e.chargeJpy)}}class X{constructor(e,n,t,r,c,d,u,v,y,I,T,m,ye,ge,me,pe,_e,ve,Se){this.id=e,this.wsId=n,this.periodFrom=t,this.periodTo=r,this.billStatusId=c,this.subtotalJpy=d,this.discountJpy=u,this.subtotalAfterDiscountJpy=v,this.vatJpy=y,this.dueJpy=I,this.billingCountryId=T,this.billingAddress=m,this.billingName=ye,this.paymentMethodId=ge,this.paymentIntentClientSecret=me,this.paymentAuthRequired=pe,this.numCollectAttempts=_e,this.invoiceUrl=ve,this.paidAt=Se}static create(e){return new X(e.id,e.wsId,new Date(e.periodFrom),new Date(e.periodTo),e.billStatusId,e.subtotalJpy,e.discountJpy,e.subtotalAfterDiscountJpy,e.vatJpy,e.dueJpy,e.billingCountryId,e.billingAddress,e.billingName,e.paymentMethodId,e.paymentIntentClientSecret,e.paymentAuthRequired,e.numCollectAttempts,e.invoiceUrl,e.paidAt?new Date(e.paidAt):void 0)}}const N=class N{};l(N,"listOfPayment",async e=>Promise.resolve(k.createSuccessful(N.chargesOfBills[e.id]))),l(N,"chargesOfBills",{1:[P.create({id:1,paymentId:1,chargeType:p.Product,chargedFrom:new Date().toISOString(),chargedTo:new Date().toISOString(),chargeJpy:1e3}),P.create({id:2,paymentId:1,chargeType:p.Product,chargedFrom:new Date().toISOString(),chargedTo:new Date().toISOString(),chargeJpy:2e3}),P.create({id:3,paymentId:1,chargeType:p.Product,chargedFrom:new Date().toISOString(),chargedTo:new Date().toISOString(),chargeJpy:3e3})],2:[P.create({id:4,paymentId:2,chargeType:p.Product,chargedFrom:new Date().toISOString(),chargedTo:new Date().toISOString(),chargeJpy:4e3}),P.create({id:5,paymentId:2,chargeType:p.Product,chargedFrom:new Date().toISOString(),chargedTo:new Date().toISOString(),chargeJpy:5e3}),P.create({id:6,paymentId:2,chargeType:p.Product,chargedFrom:new Date().toISOString(),chargedTo:new Date().toISOString(),chargeJpy:6e3})]});let te=N;const Qe={class:"next-payment-panel__summary"},ze={class:"next-payment-panel__summary__item"},Ve={class:"next-payment-panel__summary__item__label"},He={class:"next-payment-panel__summary__item__value"},Ge={class:"next-payment-panel__summary__item"},Ye={class:"next-payment-panel__summary__item__label"},Xe={class:"next-payment-panel__summary__item__value"},Ke=J({__name:"next-payment",props:{estimate:{type:Object,required:!0}},setup(s){return w.create({chargeType:p.Product,chargedFrom:new Date().toISOString(),chargedTo:new Date().toISOString(),chargeJpy:100}),w.create({chargeType:p.Product,chargedFrom:new Date().toISOString(),chargedTo:new Date().toISOString(),chargeJpy:200}),w.create({chargeType:p.User,chargedFrom:new Date().toISOString(),chargedTo:new Date().toISOString(),chargeJpy:300}),w.create({chargeType:p.User,chargedFrom:new Date().toISOString(),chargedTo:new Date().toISOString(),chargeJpy:400}),S(!1),S(null),S(0),(e,n)=>(g(),F(j,{class:"next-payment-panel",title:o(i).nextBillingScheduled()},{default:b(()=>[a("div",Qe,[a("div",ze,[a("span",Ve,h(o(i).estimatedAmount()),1),a("span",He,h(o(ne).toPriceJpyString(s.estimate.estimateJpy)),1)]),a("div",Ge,[a("span",Ye,h(o(i).scheduledDate()),1),a("span",Xe,h(o(de).getBeginningOfTheNextMonth(new Date,!1).toLocaleDateString()),1)])])]),_:1},8,["title"]))}}),Ze=E(Ke,[["__scopeId","data-v-bd94b126"]]),et={class:"container"},tt={class:"container__card"},at=J({__name:"cc",props:{truncatedNumber:{type:String,required:!1,default:""}},setup(s){const e=()=>{M.push(new ue({createPaymentSetupIntent:se.create,createPaymentMethod:D.create,listPaymentMethods:D.list,deletePaymentMethod:D.delete}))};return(n,t)=>(g(),F(j,{title:o(i).creditCardInUse()},{default:b(()=>[a("div",et,[s.truncatedNumber?(g(),f(B,{key:0},[a("div",tt,[a("span",null,h(s.truncatedNumber),1)]),C(V,{onClick:e},{default:b(()=>[z(h(o(i).change()),1)]),_:1})],64)):(g(),f(B,{key:1},[a("span",null,h(o(i).pleaseRegisterPaymentMethod()),1),C(V,{onClick:e},{default:b(()=>[z(h(o(i).register()),1)]),_:1})],64))])]),_:1},8,["title"]))}}),nt=E(at,[["__scopeId","data-v-ec91f312"]]),A=class A{};l(A,"list",async e=>{const n=new URLSearchParams;e.wsId&&n.append(ie,e.wsId.toString()),e.statusIds&&n.append(De,e.statusIds.join(","));const t=await oe.get(A.path+"?"+n.toString());if(!t.successful||!t.value.ok)return L.createFailed([],t.value,t.errorStack);const r=await t.value.json();return L.createSuccessful(r.items.map(X.create),t.value)}),l(A,"path","/bills");let W=A;class st extends ce{constructor(){super(...arguments);l(this,"listFailed",async n=>{if(this.failedBills.exhaustive())return k.createSuccessful(this.failedBills.list());const t=await W.list({wsId:n.wsId,statusIds:[Pe]});return this.failedBills.setList(t.value,!0),k.createSuccessful(t.value)});l(this,"listRecent",async n=>{if(this.recentBills.exhaustive())return k.createSuccessful(this.recentBills.list());const t=await W.list({wsId:n.wsId});return this.recentBills.setList(t.value,!0),k.createSuccessful(t.value)});l(this,"failedBills",Z.createEmpty());l(this,"recentBills",Z.createEmpty())}}const rt=new st,he=rt,it={class:"container"},ot={key:0,class:"table"},ct={key:1},lt=J({__name:"history",setup(s){const e=S([]),n=async r=>{if(!r.invoiceUrl){_.handleError(new Error(`bill.invoiceUrl is not set for bill(${r.id})`),i.failedToFetchData());return}try{const d=await(await fetch(r.invoiceUrl,{credentials:"include"})).blob(),u=document.createElement("a");u.href=URL.createObjectURL(d),u.download=`${i.invoice().toLowerCase()}_${r.periodFrom.getFullYear()}_${r.periodFrom.getMonth()+1}.pdf`,u.click(),URL.revokeObjectURL(u.href)}catch(c){_.handleError(c,i.failedToFetchData())}},t=r=>r.paidAt?r.paidAt.toLocaleDateString():(_.handleErrorQuietly(new Error(`bill.paidAt is not set for bill(${r.id})`)),"");return G(()=>{const r=Y.getWsp();if(!r)return _.handleError(O.createWsNotFoundError());he.listRecent(r).then(c=>{if(!c.successful){_.handleErrorStack(c.errorStack,i.failedToFetchData());return}e.value=c.value})}),(r,c)=>(g(),F(j,{title:o(i).previousBills()},{default:b(()=>[a("div",it,[e.value.length?(g(),f("table",ot,[a("thead",null,[a("tr",null,[a("th",null,h(o(i).paymentDate()),1),a("th",null,h(o(i).amount()),1),a("th",null,h(o(i).bill()),1)])]),a("tbody",null,[(g(!0),f(B,null,re(e.value,d=>(g(),f("tr",{key:d.id},[a("td",null,h(t(d)),1),a("td",null,h(o(ne).toPriceJpyString(d.dueJpy)),1),a("td",null,[C($e,{src:"/icon/note.svg","dark-src":"/icon/note-silver.svg",size:o(ee).createS(),"icon-size":o(ee).createM(),alt:o(i).bill(),onClick:()=>n(d)},null,8,["size","icon-size","alt","onClick"])])]))),128))])])):(g(),f("div",ct,h(o(i).nothingYet()),1))])]),_:1},8,["title"]))}}),dt=E(lt,[["__scopeId","data-v-742f6610"]]),ut={class:"container"},ht={class:"container__item"},yt={class:"container__item__label"},gt={class:"container__item__value"},mt={class:"container__item"},pt={class:"container__item__label"},_t={class:"container__item__value"},vt={class:"container__item"},St={class:"container__item__label"},ft={class:"container__item__value"},wt=J({__name:"billing-address",setup(s){w.create({chargeType:p.Product,chargedFrom:new Date().toISOString(),chargedTo:new Date().toISOString(),chargeJpy:100}),w.create({chargeType:p.Product,chargedFrom:new Date().toISOString(),chargedTo:new Date().toISOString(),chargeJpy:200}),w.create({chargeType:p.User,chargedFrom:new Date().toISOString(),chargedTo:new Date().toISOString(),chargeJpy:300}),w.create({chargeType:p.User,chargedFrom:new Date().toISOString(),chargedTo:new Date().toISOString(),chargeJpy:400});const e=S(),n=S(),t=async d=>{if(!d){_.handleErrorQuietly(O.createUiError("countryId is not set"));return}const u=await K.get(d);if(!u.successful){_.handleErrorStack(u.errorStack,i.failedToFetchData());return}n.value=u.value},r=()=>{if(!e.value){_.handleError(O.createWsNotFoundError());return}M.push(new xe({ws:e.value,listCountries:K.list,updateWorkspace:R.update}))},c=d=>{var u,v;for(const y of d)if(y.id===((u=e.value)==null?void 0:u.id)){e.value=y;break}t((v=e.value)==null?void 0:v.billingCountryId)};return G(async()=>{const d=Y.getWsp();if(!d){_.handleError(O.createWsNotFoundError());return}const u=await R.get(d.wsId);if(!u.successful){_.handleErrorStack(u.errorStack,i.failedToFetchData());return}e.value=u.value,t(e.value.billingCountryId),R.subscribeToMinesChangeEvent(c)}),le(()=>{R.unsubscribeFromMinesChangeEvent(c)}),(d,u)=>(g(),F(j,{editable:!0,title:o(i).billingAddress(),onEdit:r},{default:b(()=>{var v,y,I;return[a("div",ut,[a("div",ht,[a("div",yt,h(o(i).billingName()),1),a("div",gt,h(((v=e.value)==null?void 0:v.billingName)||""),1)]),a("div",mt,[a("div",pt,h(o(i).countryOrRegion()),1),a("div",_t,h(((y=n.value)==null?void 0:y.label)||""),1)]),a("div",vt,[a("div",St,h(o(i).address()),1),a("div",ft,h(((I=e.value)==null?void 0:I.billingAddress)||""),1)])])]}),_:1},8,["title"]))}}),It=E(wt,[["__scopeId","data-v-003ccedf"]]);class Q{constructor(e,n,t,r,c,d,u,v,y){this.id=e,this.wsId=n,this.periodFrom=t,this.periodTo=r,this.subtotalJpy=c,this.discountJpy=d,this.subtotalAfterDiscountJpy=u,this.vatJpy=v,this.estimateJpy=y}static create(e){return new Q(e.id,e.wsId,new Date(e.periodFrom),new Date(e.periodTo),e.subtotalJpy,e.discountJpy,e.subtotalAfterDiscountJpy,e.vatJpy,e.estimateJpy)}}const ae=Q.create({id:-1,wsId:-1,periodFrom:"1970-01-01",periodTo:"1970-01-01",subtotalJpy:-1,discountJpy:-1,subtotalAfterDiscountJpy:-1,vatJpy:-1,estimateJpy:-1}),x=class x{};l(x,"list",async e=>{const n=new URLSearchParams;e.wsId&&n.append(ie,e.wsId.toString()),e.periodFrom&&n.append(ke,e.periodFrom.toISOString());const t=await oe.get(x.path+"?"+n.toString());if(!t.successful||!t.value.ok)return L.createFailed([],t.value,t.errorStack);const r=await t.value.json();return L.createSuccessful(r.items.map(Q.create),t.value)}),l(x,"path","/estimates");let H=x;class bt extends ce{constructor(){super(...arguments);l(this,"getCurrentEstimate",async n=>{if(!this.currentEstimate){const t=await H.list({wsId:n.wsId,periodFrom:de.getBeginningOfTheMonth(new Date,!0)});if(!t.successful)return k.createFailed(ae,t.errorStack);if(t.value.length===0)return k.createFailed(ae,Fe.createFromMsg("No estimate found"));this.currentEstimate=t.value[0]}return k.createSuccessful(this.currentEstimate)});l(this,"currentEstimate",null)}}const Dt=new bt,Pt=Dt;class kt{static buildFailedPaymentNotice(e){return e.paymentAuthRequired?{msg:i.paymentFailedDueToAuthenticationPleaseTryAgain(e.periodFrom,e.periodTo),actions:[{id:"auth",label:i.authenticate(),onClick:()=>{M.push(new Ae(e))}}]}:e.paymentMethodId?{msg:i.paymentFailedPleaseTryAgain(e.periodFrom,e.periodTo),actions:[{id:"pay",label:i.makePayment(),onClick:()=>{M.push(new Ne(e))}}]}:{msg:i.paymentFailedDueToEmptyPaymentMethod(e.periodFrom,e.periodTo),actions:[{id:"register-payment-method",label:i.register(),onClick:()=>{M.push(new ue({createPaymentSetupIntent:se.create,createPaymentMethod:D.create,listPaymentMethods:D.list,deletePaymentMethod:D.delete}))}}]}}}const Ft={class:"heading2 mb-m center"},Tt=["data-has-notice"],Ct={key:0,class:"container__notice"},Jt={class:"container__next"},Et={class:"container__cc"},Ot={class:"container__billing-address"},Mt={class:"container__history"},$t=J({__name:"billing",setup(s){const e=S(""),n=S([]),t=S([]),r=S(),c=S(),d=y=>{if(y.length===0)return;const I=y[0],{msg:T,actions:m}=kt.buildFailedPaymentNotice(I);e.value=T,n.value=m},u=y=>"**** **** **** "+y,v=y=>{y.typ===Ee.Create&&(r.value=u(y.items[0].ccLast4))};return G(()=>{const y=Oe(),I=new Date(y.query[Te]);Math.abs(Date.now()-I.getTime())<1e3*60*10&&Ce.add(Je.createSuccess(i.paymentRetried()));const T=Y.getWsp();if(!T)return _.handleError(O.createWsNotFoundError());he.listFailed(T).then(m=>{if(!m.successful){_.handleErrorStackQuietly(m.errorStack);return}t.value=m.value,d(t.value)}),D.list().then(m=>{if(!m.successful){_.handleErrorStackQuietly(m.errorStack);return}m.value.length===0?r.value="":r.value=u(m.value[0].ccLast4)}),Pt.getCurrentEstimate(T).then(m=>{if(!m.successful){_.handleErrorStackQuietly(m.errorStack);return}c.value=m.value}),D.subscribeToEvent(v)}),le(()=>{D.unsubscribeFromEvent(v)}),(y,I)=>(g(),F(be,{"zen-right-bar":!0},{default:b(()=>[a("h2",Ft,h(o(i).billing()),1),a("div",{class:"container","data-has-notice":!!e.value},[e.value?(g(),f("div",Ct,[C(qe,{typ:o($).Error,msg:e.value,actions:n.value},null,8,["typ","msg","actions"])])):U("",!0),a("div",Jt,[c.value?(g(),F(Ze,{key:0,estimate:c.value},null,8,["estimate"])):U("",!0)]),a("div",Et,[r.value!==void 0?(g(),F(nt,{key:0,"truncated-number":r.value},null,8,["truncated-number"])):U("",!0)]),a("div",Ot,[C(It)]),a("div",Mt,[C(dt)])],8,Tt)]),_:1}))}}),jt=E($t,[["__scopeId","data-v-7ea36b16"]]);export{jt as default};
