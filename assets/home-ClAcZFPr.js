import{B as V,a as O,A as j}from"./index-CCdNvfV5.js";import{E as D,z as G,S as l,B as H,I as u,N as P,d as b,r as A,o as f,c as E,j as h,t as p,u as m,f as _,w as T,F as N,C as $,i as U,l as x,k as z,D as Q,b as q,G as W,R as L,H as R,M as J,J as K,K as X,O as Y,P as Z,Q as ee,T as te,U as se}from"./index-CI1TXeFk.js";import{D as ae}from"./date-DLmiVZsx.js";import{B as ne,C as oe,b as ie,A as re}from"./error-ByG0LKAC.js";import{_ as g}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{M as B}from"./index.vue_vue_type_style_index_0_scoped_f01006ee_lang-ijOL3OAg.js";var C=(e=>(e.General="general",e.New="new",e))(C||{});class k{constructor(t,o,n,i,c=[]){this.typ=t,this.title=o,this.at=n,this.newAfter=i,this.actions=c}static async create(t){let o=[];if([D.Discussion,D.DiscussionComment].includes(t.e.typ)){const n=t.e.typ===D.Discussion?t.e.deDid:t.e.dceDid,i=await G.get(n);i.successful||l.handleErrorStackQuietly(i.errorStack);const c=await H.get(i.value.pid);c.successful||l.handleErrorStackQuietly(c.errorStack),o=[{label:u.viewDiscussion(),onClick:()=>window.location.href=P.buildDiscussionUrl(c.value.wsFid,c.value.fid,i.value.id)}]}return new k("general",await t.e.buildTitle(),t.e.createdAt,t.newAfter,o)}static createNew(){return new k("new","",new Date)}}const ce={class:"home-event-item"},le=["data-new"],ue={class:"home-event-item__front__col nowrap"},de=["data-show-back"],ve=b({__name:"general",props:{event:{type:Object,required:!0}},setup(e){const t=A(!1);return(o,n)=>(f(),E("div",ce,[h("div",{class:"home-event-item__front",onClick:n[0]||(n[0]=i=>t.value=!t.value)},[h("div",{class:"home-event-item__front__col home-event-item__front__col--title","data-new":e.event.newAfter?e.event.at>e.event.newAfter:!0},p(e.event.title),9,le),h("div",ue,p(m(ae).ago(e.event.at)),1)]),h("div",{class:"home-event-item__back","data-show-back":t.value},[e.event.actions.length>0?(f(),_(V,{key:0,"align-h":m(re).Left,"tight-gap":!0,class:"home-event-item__back__btn-group"},{default:T(()=>[(f(!0),E(N,null,$(e.event.actions,(i,c)=>(f(),_(ne,{size:m(oe).createS(),key:c,fat:!0,theme:m(ie).Primary,onClick:i.onClick},{default:T(()=>[U(p(i.label),1)]),_:2},1032,["size","theme","onClick"]))),128))]),_:1},8,["align-h"])):x("",!0)],8,de)]))}}),fe=g(ve,[["__scopeId","data-v-b12ecdfe"]]),me={class:"home-event-item--new"},he={class:"home-event-item--new__label"},_e=b({__name:"new",props:{event:{type:Object,required:!0}},setup(e){return(t,o)=>(f(),E("div",me,[h("div",he,p(m(u).new()),1),z(O,{color:m(Q)},null,8,["color"])]))}}),we=g(_e,[["__scopeId","data-v-4d8c2ea6"]]),pe=b({__name:"index",props:{event:{type:Object,required:!0}},setup(e){return(t,o)=>e.event.typ===m(C).General?(f(),_(fe,{key:0,event:e.event},null,8,["event"])):e.event.typ===m(C).New?(f(),_(we,{key:1,event:e.event},null,8,["event"])):x("",!0)}}),ke=g(pe,[["__scopeId","data-v-7847767c"]]),Ee={class:"home"},be=["data-testid"],ge={class:"home__events"},ye="home",Se=b({__name:"home",setup(e){const t=A([]),o=A();let n={};const i=s=>{if(console.log("onEvent",s),s.data.typ!==L.Delete){for(const d of s.data.items)n[d.id]=d;c()}},c=async()=>{const s=Object.values(n);s.sort((r,w)=>w.id-r.id);const d=s.filter(r=>o.value?r.createdAt>=o.value:!0).length,v=(await Promise.all(s.map(r=>k.create({e:r,newAfter:o.value})))).filter(r=>r.title!=="");t.value=d===0||v.length<2?v:[...v.slice(0,d),k.createNew(),...v.slice(d)]},I=async()=>{const s=await R.get();if(!s.successful){l.handleErrorStack(s.errorStack,u.failedToFetchData());return}s.value&&(o.value=s.value.visitedAt);const d=J.getWsp();if(!d)l.handleErrorQuietly(K.createWsNotFoundError());else{const a=await X.listByWsId(d.wsId);if(!a.successful)l.handleErrorStack(a.errorStack,u.failedToFetchData());else for(const F of a.value)n[F.id]=F}const v=await Y.list();if(!v.successful)l.handleErrorStack(v.errorStack,u.failedToFetchData());else for(const a of v.value)n[a.id]=a;const r=await Z.list();if(!r.successful)l.handleErrorStack(r.errorStack,u.failedToFetchData());else for(const a of r.value)n[a.id]=a;const w=await ee.list();if(!w.successful)l.handleErrorStack(w.errorStack,u.failedToFetchData());else for(const a of w.value)n[a.id]=a;const y=await te.list();if(!y.successful)l.handleErrorStack(y.errorStack,u.failedToFetchData());else for(const a of y.value)n[a.id]=a;const S=await se.list();if(!S.successful)l.handleErrorStack(S.errorStack,u.failedToFetchData());else for(const a of S.value)n[a.id]=a},M=async()=>{const s=await R.get();s.successful||l.handleErrorStack(s.errorStack,u.failedToFetchData()),s.value&&(o.value=s.value.visitedAt),R.put()};return q(async()=>{B.subscribeToHomeEvent(i),await M(),await I(),c()}),W(()=>{B.unsubscribeFromHomeEvent(i)}),(s,d)=>(f(),_(j,null,{default:T(()=>[h("div",Ee,[h("h2",{class:"heading2 mb-m center","data-testid":`${ye}__h2`},p(m(u).recentEvents()),9,be),h("div",ge,[(f(!0),E(N,null,$(t.value,(v,r)=>(f(),_(ke,{key:r,event:v,class:"home__events__item"},null,8,["event"]))),128))])])]),_:1}))}}),Be=g(Se,[["__scopeId","data-v-0808f214"]]);export{Be as default};
